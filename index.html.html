<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Stamper — 3 Spots (Folder Auto‑Detect)</title>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --fg:#e5e7eb; --accent:#22d3ee; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);} 
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .card{background:var(--panel);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:20px;border:1px solid #1f2937}
    h1{font-size:28px;margin:0 0 6px}
    p.sub{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;gap:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .row4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input, select{width:100%;background:#0b1324;border:1px solid #243041;color:var(--fg);padding:10px 12px;border-radius:10px;outline:none}
    input[type="number"]{appearance:textfield}
    .chk{display:flex;gap:8px;align-items:center;margin-top:8px}
    button{appearance:none;border:0;background:var(--accent);color:#001014;font-weight:700;padding:12px 16px;border-radius:12px;cursor:pointer;transition:transform .05s ease,opacity .2s}
    button.secondary{background:#e5e7eb;color:#111}
    button:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .drop{border:2px dashed #334155;border-radius:12px;padding:10px;text-align:center}
    .section{border:1px solid #1f2937;border-radius:12px;padding:12px}
    .title{font-weight:700}
    .hidden{display:none}
    .row-actions{display:flex;gap:8px;align-items:end}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>PDF Stamper — 3 Spots (Folder Auto‑Detect)</h1>
      <p class="sub">Auto‑loads assets from the same folder as this HTML: <b>template.pdf</b>, optional <b>goldman.ttf</b>, and text from <b>text.txt</b> (first 3 lines) or <b>textA.txt/textB.txt/textC.txt</b>. Still supports manual file selection. Preview or Download.</p>

      <div class="grid">
        <div class="row">
          <div>
            <label>PDF file (or rely on <b>template.pdf</b> beside this HTML)</label>
            <div class="drop">
              <input id="pdfFile" type="file" accept="application/pdf,.pdf" style="width:100%" />
              <div class="muted" style="font-size:12px">Drag & drop works too. 72 pts = 1 inch. Origin bottom‑left.</div>
            </div>
          </div>
          <div>
            <label>Global color</label>
            <select id="colorPick">
              <option value="black" selected>Black</option>
              <option value="ef4444">Red (#EF4444)</option>
            </select>
            <div class="chk"><input id="lockFolder" type="checkbox" /> <label for="lockFolder">Prefer folder assets (auto‑reload)</label></div>
            <div class="row-actions"><button id="reload" class="secondary">Reload from folder</button><span class="muted" id="status" aria-live="polite"></span></div>
          </div>
        </div>

        <div class="section">
          <div class="title">Front (Page 1) — Text A</div>
          <div class="row4">
            <div>
              <label>Text A</label>
              <input id="textA" value="Front A" />
            </div>
            <div>
              <label>X (pts)</label>
              <input id="xA" type="number" step="1" value="72" />
              <div class="chk"><input id="cxA" type="checkbox" /> <label for="cxA">Center horizontally</label></div>
            </div>
            <div>
              <label>Y (pts)</label>
              <input id="yA" type="number" step="1" value="72" />
              <div class="chk"><input id="cyA" type="checkbox" /> <label for="cyA">Center vertically</label></div>
            </div>
            <div>
              <label>Font size</label>
              <input id="sizeA" type="number" min="6" value="18" />
              <label style="margin-top:8px">Font</label>
              <select id="fontA">
                <option value="helv" selected>Helvetica (built‑in)</option>
                <option value="goldman">Goldman (global)</option>
                <option value="custom">Custom upload</option>
              </select>
              <input id="fontFileA" type="file" accept=".ttf,.otf" class="hidden" />
            </div>
          </div>
        </div>

        <div class="section">
          <div class="title">Front (Page 1) — Text B</div>
          <div class="row4">
            <div>
              <label>Text B</label>
              <input id="textB" value="Front B" />
            </div>
            <div>
              <label>X (pts)</label>
              <input id="xB" type="number" step="1" value="72" />
              <div class="chk"><input id="cxB" type="checkbox" /> <label for="cxB">Center horizontally</label></div>
            </div>
            <div>
              <label>Y (pts)</label>
              <input id="yB" type="number" step="1" value="144" />
              <div class="chk"><input id="cyB" type="checkbox" /> <label for="cyB">Center vertically</label></div>
            </div>
            <div>
              <label>Font size</label>
              <input id="sizeB" type="number" min="6" value="18" />
              <label style="margin-top:8px">Font</label>
              <select id="fontB">
                <option value="helv" selected>Helvetica (built‑in)</option>
                <option value="goldman">Goldman (global)</option>
                <option value="custom">Custom upload</option>
              </select>
              <input id="fontFileB" type="file" accept=".ttf,.otf" class="hidden" />
            </div>
          </div>
        </div>

        <div class="section">
          <div class="title">Back (Page 2) — Text C</div>
          <div class="row4">
            <div>
              <label>Text C</label>
              <input id="textC" value="Back C" />
            </div>
            <div>
              <label>X (pts)</label>
              <input id="xC" type="number" step="1" value="72" />
              <div class="chk"><input id="cxC" type="checkbox" /> <label for="cxC">Center horizontally</label></div>
            </div>
            <div>
              <label>Y (pts)</label>
              <input id="yC" type="number" step="1" value="72" />
              <div class="chk"><input id="cyC" type="checkbox" /> <label for="cyC">Center vertically</label></div>
            </div>
            <div>
              <label>Font size</label>
              <input id="sizeC" type="number" min="6" value="18" />
              <label style="margin-top:8px">Font</label>
              <select id="fontC">
                <option value="helv" selected>Helvetica (built‑in)</option>
                <option value="goldman">Goldman (global)</option>
                <option value="custom">Custom upload</option>
              </select>
              <input id="fontFileC" type="file" accept=".ttf,.otf" class="hidden" />
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Output filename</label>
            <input id="outName" value="stamped-3spots.pdf" />
          </div>
          <div class="row-actions">
            <button id="preview" class="secondary">Preview</button>
            <button id="download">Download</button>
          </div>
        </div>
      </div>

      <p class="muted" style="font-size:12px;margin-top:8px">Note: Some browsers block <code>file://</code> fetches. If auto‑load fails when opening the HTML directly, serve this folder with a tiny local web server (e.g., <code>python -m http.server</code>) or use the file pickers.</p>
    </div>
  </div>

<script>
(async function(){
  const { PDFDocument, StandardFonts, rgb } = PDFLib;
  const fontkit = window.fontkit;
  const $ = id => document.getElementById(id);
  const status = $('status');

  // Toggle custom font file inputs
  function wireFontSelect(selectId, fileInputId){
    const sel = $(selectId), file = $(fileInputId);
    const update = ()=>{ file.classList.toggle('hidden', sel.value !== 'custom'); };
    sel.addEventListener('change', update); update();
  }
  ['A','B','C'].forEach(k=> wireFontSelect('font'+k, 'fontFile'+k));

  // Drag & drop onto file input wrapper
  const drop = $('pdfFile').parentElement.parentElement; // .drop
  ['dragenter','dragover'].forEach(evt=> drop.addEventListener(evt, e=>{e.preventDefault(); drop.style.borderColor='#475569'}));
  ['dragleave','drop'].forEach(evt=> drop.addEventListener(evt, e=>{e.preventDefault(); drop.style.borderColor='#334155'}));
  drop.addEventListener('drop', e=>{
    const f = e.dataTransfer?.files?.[0];
    if(f && (f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'))){ $('pdfFile').files = e.dataTransfer.files; }
  });

  // Folder auto‑load helpers
  async function tryFetchArrayBuffer(url){
    try { const res = await fetch(url); if(res.ok) return await res.arrayBuffer(); } catch(_) {}
    return null;
  }
  async function tryFetchText(url){
    try { const res = await fetch(url); if(res.ok) return await res.text(); } catch(_) {}
    return null;
  }

  async function loadPdf(){
    const f = $('pdfFile').files?.[0];
    if(f) return await f.arrayBuffer();
    if ($('lockFolder').checked){
      const buf = await tryFetchArrayBuffer('template.pdf'); if(buf) return buf;
    }
    // fallback attempt regardless of lock
    const buf2 = await tryFetchArrayBuffer('template.pdf'); if(buf2) return buf2;
    throw new Error('No PDF provided. Choose a file or place template.pdf next to this HTML.');
  }

  async function loadGoldmanBuffer(){
    const g = $('goldmanFile').files?.[0];
    if (g) return await g.arrayBuffer();
    if ($('lockFolder').checked){
      const buf = await tryFetchArrayBuffer('goldman.ttf'); if(buf) return buf;
    } else {
      const buf = await tryFetchArrayBuffer('goldman.ttf'); if(buf) return buf;
    }
    return null;
  }

  async function loadTextsFromFolder(){
    // Priority: textA/B/C.txt; fallback: text.txt (first 3 non‑empty lines)
    const ta = await tryFetchText('textA.txt');
    const tb = await tryFetchText('textB.txt');
    const tc = await tryFetchText('textC.txt');
    if (ta!=null) $('textA').value = ta.trim();
    if (tb!=null) $('textB').value = tb.trim();
    if (tc!=null) $('textC').value = tc.trim();
    if (ta==null || tb==null || tc==null){
      const t = await tryFetchText('text.txt');
      if (t){
        const lines = t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if (ta==null && lines[0]) $('textA').value = lines[0];
        if (tb==null && lines[1]) $('textB').value = lines[1];
        if (tc==null && lines[2]) $('textC').value = lines[2];
      }
    }
  }

  function getColor(){
    return $('colorPick').value === 'ef4444' ? rgb(0xEF/255, 0x44/255, 0x44/255) : rgb(0,0,0);
  }

  async function resolveFont(pdfDoc, selectId, fileId, goldmanBuf, helv){
    const val = $(selectId).value;
    if (val === 'helv') return helv;
    if (val === 'goldman'){
      if (goldmanBuf){ try { return await pdfDoc.embedFont(goldmanBuf, { subset:true }); } catch(e){ console.warn('Goldman embed failed', e); } }
      return helv;
    }
    if (val === 'custom'){
      const f = $(fileId).files?.[0];
      if (f){ try { const buf = await f.arrayBuffer(); return await pdfDoc.embedFont(buf, { subset:true }); } catch(e){ console.warn('Custom font embed failed', e); } }
      return helv;
    }
    return helv;
  }

  function computeXY({text,size,font,pageW,pageH,x,y,cx,cy}){
    const tw = font.widthOfTextAtSize(text, size);
    const th = font.heightAtSize(size);
    const out = { x: parseFloat(x||'0'), y: parseFloat(y||'0') };
    if (cx) out.x = (pageW - tw)/2;
    if (cy) out.y = (pageH - th)/2; // baseline approx
    return out;
  }

  async function buildStampedPdf(){
    const pdfBytes = await loadPdf();
    const pdfDoc = await PDFDocument.load(pdfBytes);
    if (fontkit) pdfDoc.registerFontkit(fontkit);

    const helv = await pdfDoc.embedFont(StandardFonts.Helvetica);
    const goldmanBuf = await loadGoldmanBuffer();

    const c = getColor();

    // Page 1
    const front = pdfDoc.getPage(0);
    const { width: fw, height: fh } = front.getSize();
    const fontA = await resolveFont(pdfDoc,'fontA','fontFileA',goldmanBuf,helv);
    const sizeA = Math.max(1, parseFloat($('sizeA').value||'18'));
    const textA = ($('textA').value||'');
    const xyA = computeXY({ text: textA, size: sizeA, font: fontA, pageW: fw, pageH: fh, x: $('xA').value, y: $('yA').value, cx: $('cxA').checked, cy: $('cyA').checked });
    front.drawText(textA, { x: xyA.x, y: xyA.y, size: sizeA, font: fontA, color: c });

    const fontB = await resolveFont(pdfDoc,'fontB','fontFileB',goldmanBuf,helv);
    const sizeB = Math.max(1, parseFloat($('sizeB').value||'18'));
    const textB = ($('textB').value||'');
    const xyB = computeXY({ text: textB, size: sizeB, font: fontB, pageW: fw, pageH: fh, x: $('xB').value, y: $('yB').value, cx: $('cxB').checked, cy: $('cyB').checked });
    front.drawText(textB, { x: xyB.x, y: xyB.y, size: sizeB, font: fontB, color: c });

    // Page 2
    if (pdfDoc.getPageCount() < 2) throw new Error('Your PDF has only 1 page; need a back page.');
    const back = pdfDoc.getPage(1);
    const { width: bw, height: bh } = back.getSize();
    const fontC = await resolveFont(pdfDoc,'fontC','fontFileC',goldmanBuf,helv);
    const sizeC = Math.max(1, parseFloat($('sizeC').value||'18'));
    const textC = ($('textC').value||'');
    const xyC = computeXY({ text: textC, size: sizeC, font: fontC, pageW: bw, pageH: bh, x: $('xC').value, y: $('yC').value, cx: $('cxC').checked, cy: $('cyC').checked });
    back.drawText(textC, { x: xyC.x, y: xyC.y, size: sizeC, font: fontC, color: c });

    return await pdfDoc.save();
  }

  function anchorDownload(bytes, name){
    const blob = new Blob([bytes], { type: 'application/pdf' });
    const blobUrl = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = blobUrl; a.download = name; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(blobUrl), 1500);
  }

  function openPreview(bytes, name){
    const blob = new Blob([bytes], { type: 'application/pdf' });
    if (window.navigator && window.navigator.msSaveOrOpenBlob){ window.navigator.msSaveOrOpenBlob(blob, name); return; }
    const blobUrl = URL.createObjectURL(blob);
    const w = window.open('', '_blank', 'noopener');
    if (w) {
      w.document.title = name; w.document.body.style.margin = '0';
      const bar = w.document.createElement('div'); bar.style.cssText = 'position:fixed;top:0;left:0;right:0;height:48px;display:flex;gap:8px;align-items:center;padding:0 12px;background:#111;color:#eee;font-family:system-ui,Segoe UI,Roboto;z-index:10;';
      const btnDl = w.document.createElement('button'); btnDl.textContent = 'Download'; btnDl.style.cssText = 'padding:6px 10px;border:0;border-radius:8px;background:#22d3ee;color:#001014;font-weight:700;cursor:pointer;';
      const btnPr = w.document.createElement('button'); btnPr.textContent = 'Print'; btnPr.style.cssText = 'padding:6px 10px;border:0;border-radius:8px;background:#e5e7eb;color:#111;font-weight:700;cursor:pointer;';
      const iframe = w.document.createElement('iframe'); iframe.style.cssText = 'position:fixed;top:48px;left:0;width:100%;height:calc(100vh - 48px);border:0;'; iframe.src = blobUrl;
      btnDl.onclick = ()=> anchorDownload(bytes, name); btnPr.onclick = ()=> { iframe.contentWindow&&iframe.contentWindow.focus(); w.print(); };
      w.document.body.appendChild(bar); bar.appendChild(btnDl); bar.appendChild(btnPr); w.document.body.appendChild(iframe);
      w.addEventListener('beforeunload', ()=> URL.revokeObjectURL(blobUrl));
    } else {
      window.location.assign(blobUrl); setTimeout(()=> URL.revokeObjectURL(blobUrl), 120000);
    }
  }

  async function doPreview(){
    try { status.textContent='Working…'; const bytes = await buildStampedPdf(); openPreview(bytes, ($('outName').value||'stamped-3spots.pdf').replace(/\s+/g,'_')); status.textContent='Opened preview tab.'; }
    catch(err){ console.error(err); status.textContent='Error: '+(err?.message||err); alert('PDF Error:\n'+(err?.message||err)); }
  }
  async function doDownload(){
    try { status.textContent='Working…'; const bytes = await buildStampedPdf(); anchorDownload(bytes, ($('outName').value||'stamped-3spots.pdf').replace(/\s+/g,'_')); status.textContent='Download started.'; }
    catch(err){ console.error(err); status.textContent='Error: '+(err?.message||err); alert('PDF Error:\n'+(err?.message||err)); }
  }

  async function doReload(){
    try{ status.textContent='Loading from folder…'; await loadTextsFromFolder(); status.textContent='Loaded.'; }
    catch(e){ status.textContent=''; }
  }

  // Wire buttons
  document.getElementById('preview').addEventListener('click', doPreview);
  document.getElementById('download').addEventListener('click', doDownload);
  document.getElementById('reload').addEventListener('click', doReload);

  // Initial attempt to pull from folder
  await doReload();
})();
</script>
</body>
</html>