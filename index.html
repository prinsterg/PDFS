<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Stamper — Fixed Build (GitHub Pages)</title>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --fg:#e5e7eb; --accent:#22d3ee; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);} 
    .wrap{max-width:900px;margin:32px auto;padding:0 16px}
    .card{background:var(--panel);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:20px;border:1px solid #1f2937}
    h1{font-size:28px;margin:0 0 6px}
    p.sub{color:var(--muted);margin:0 0 16px}
    button{appearance:none;border:0;background:var(--accent);color:#001014;font-weight:700;padding:12px 16px;border-radius:12px;cursor:pointer;transition:transform .05s ease,opacity .2s;margin-right:8px}
    button.secondary{background:#e5e7eb;color:#111}
    button:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    code{background:#0b1324;border:1px solid #243041;border-radius:8px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>PDF Stamper — Fixed Build (GitHub Pages)</h1>
      <p class="sub">This build removes all file pickers and uses assets in the same folder as this page. It will stamp your PDF using the exact settings you provided.</p>

      <ul class="muted">
        <li><b>Loads</b> <code>template.pdf</code> from the same folder.</li>
        <li><b>Fonts</b> (if present): <code>Goldman-Regular.ttf</code> and <code>Goldman-Bold.ttf</code> (case‑sensitive).</li>
        <li><b>Color</b>: <code>#EF4444</code>.</li>
        <li><b>Front (page 1)</b> — Text A: <code>"6"</code> at (1130, 377), size 70, Goldman Regular.</li>
        <li><b>Front (page 1)</b> — Text B: <code>"210"</code> at (1789, 377), size 70, Goldman Regular.</li>
        <li><b>Back (page 2)</b> — Text C: <code>"Yourgay123"</code> centered horizontally, y=685, size 100, Goldman Bold.</li>
      </ul>

      <div>
        <button id="preview" class="secondary">Preview</button>
        <button id="download">Download</button>
        <span class="muted" id="status" style="margin-left:12px" aria-live="polite"></span>
      </div>

      <p class="muted" style="margin-top:12px">Place this file, <code>template.pdf</code>, and the two font files (optional) together. If a font file is missing, the app falls back to Helvetica.</p>
    </div>
  </div>

<script>
(async function(){
  const { PDFDocument, StandardFonts, rgb } = PDFLib;
  const fontkit = window.fontkit;
  const status = document.getElementById('status');

  // ---- Hardcoded settings from your screenshot ----
  const RED = rgb(0xEF/255, 0x44/255, 0x44/255);
  const S = {
    A: { text: '6',    x: 1130, y: 377, size: 70, font: 'goldman-regular' },
    B: { text: '210',  x: 1789, y: 377, size: 70, font: 'goldman-regular' },
    C: { text: 'Yourgay123', x: 1000, y: 685, size: 100, font: 'goldman-bold', centerX: true }
  };
  const OUT_NAME = 'stamped-3spots.pdf';

  async function fetchArrayBuffer(url){
    const res = await fetch(url, { cache: 'no-cache' });
    if(!res.ok) throw new Error('Missing required asset: ' + url);
    return await res.arrayBuffer();
  }

  async function tryFetchArrayBuffer(url){
    try { return await fetchArrayBuffer(url); } catch(_) { return null; }
  }

  async function loadPdf(){
    return await fetchArrayBuffer('template.pdf');
  }

  async function buildStamped(){
    const pdfBytes = await loadPdf();
    const pdfDoc = await PDFDocument.load(pdfBytes);
    if (fontkit) pdfDoc.registerFontkit(fontkit);

    const helv = await pdfDoc.embedFont(StandardFonts.Helvetica);

    // Load fonts if available
    let goldmanRegular = helv;
    let goldmanBold = helv;
    const regBuf = await tryFetchArrayBuffer('Goldman-Regular.ttf');
    if (regBuf){ try { goldmanRegular = await pdfDoc.embedFont(regBuf, { subset: true }); } catch(_){} }
    const boldBuf = await tryFetchArrayBuffer('Goldman-Bold.ttf');
    if (boldBuf){ try { goldmanBold = await pdfDoc.embedFont(boldBuf, { subset: true }); } catch(_){} }

    function pickFont(tag){
      switch(tag){
        case 'goldman-regular': return goldmanRegular;
        case 'goldman-bold': return goldmanBold;
        default: return helv;
      }
    }

    // FRONT (page 1)
    const front = pdfDoc.getPage(0);
    const { width: fw, height: fh } = front.getSize();

    const fA = pickFont(S.A.font);
    front.drawText(S.A.text, { x: S.A.x, y: S.A.y, size: S.A.size, color: RED, font: fA });

    const fB = pickFont(S.B.font);
    front.drawText(S.B.text, { x: S.B.x, y: S.B.y, size: S.B.size, color: RED, font: fB });

    // BACK (page 2)
    if (pdfDoc.getPageCount() < 2) throw new Error('template.pdf has only 1 page; need a back page.');
    const back = pdfDoc.getPage(1);
    const { width: bw } = back.getSize();

    const fC = pickFont(S.C.font);
    let cx = S.C.x;
    if (S.C.centerX){
      const tw = fC.widthOfTextAtSize(S.C.text, S.C.size);
      cx = (bw - tw) / 2;
    }
    back.drawText(S.C.text, { x: cx, y: S.C.y, size: S.C.size, color: RED, font: fC });

    return await pdfDoc.save();
  }

  function downloadBytes(bytes, name){
    const blob = new Blob([bytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
  }

  function previewBytes(bytes, name){
    const blob = new Blob([bytes], { type: 'application/pdf' });
    if (window.navigator && window.navigator.msSaveOrOpenBlob){ window.navigator.msSaveOrOpenBlob(blob, name); return; }
    const url = URL.createObjectURL(blob);
    const w = window.open('', '_blank', 'noopener');
    if (w) {
      w.document.title = name; w.document.body.style.margin = '0';
      const bar = w.document.createElement('div'); bar.style.cssText = 'position:fixed;top:0;left:0;right:0;height:48px;display:flex;gap:8px;align-items:center;padding:0 12px;background:#111;color:#eee;font-family:system-ui,Segoe UI,Roboto;z-index:10;';
      const btnDl = w.document.createElement('button'); btnDl.textContent = 'Download'; btnDl.style.cssText = 'padding:6px 10px;border:0;border-radius:8px;background:#22d3ee;color:#001014;font-weight:700;cursor:pointer;';
      const btnPr = w.document.createElement('button'); btnPr.textContent = 'Print'; btnPr.style.cssText = 'padding:6px 10px;border:0;border-radius:8px;background:#e5e7eb;color:#111;font-weight:700;cursor:pointer;';
      const iframe = w.document.createElement('iframe'); iframe.style.cssText = 'position:fixed;top:48px;left:0;width:100%;height:calc(100vh - 48px);border:0;'; iframe.src = url;
      btnDl.onclick = ()=> downloadBytes(bytes, name);
      btnPr.onclick = ()=> { iframe.contentWindow && iframe.contentWindow.focus(); w.print(); };
      w.document.body.appendChild(bar); bar.appendChild(btnDl); bar.appendChild(btnPr); w.document.body.appendChild(iframe);
      w.addEventListener('beforeunload', ()=> URL.revokeObjectURL(url));
    } else {
      window.location.assign(url); setTimeout(()=> URL.revokeObjectURL(url), 120000);
    }
  }

  async function doPreview(){
    try{ status.textContent='Working…'; const bytes = await buildStamped(); previewBytes(bytes, OUT_NAME); status.textContent='Opened preview.'; }
    catch(e){ console.error(e); alert('PDF Error:\n' + (e?.message||e)); status.textContent=''; }
  }

  async function doDownload(){
    try{ status.textContent='Working…'; const bytes = await buildStamped(); downloadBytes(bytes, OUT_NAME); status.textContent='Download started.'; }
    catch(e){ console.error(e); alert('PDF Error:\n' + (e?.message||e)); status.textContent=''; }
  }

  document.getElementById('preview').addEventListener('click', doPreview);
  document.getElementById('download').addEventListener('click', doDownload);
})();
</script>
</body>
</html>
